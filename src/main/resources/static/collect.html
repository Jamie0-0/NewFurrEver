<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>追蹤清單</title>
    <!-- bootstrap css -->
    <link id="rtl-link" rel="stylesheet" type="text/css" href="assets/css/vendors/bootstrap.css">

    <!-- wow css -->
    <link rel="stylesheet" href="assets/css/animate.min.css" />

    <!-- font-awesome css -->
    <link rel="stylesheet" type="text/css" href="assets/css/vendors/font-awesome.css">

    <!-- feather icon css -->
    <link rel="stylesheet" type="text/css" href="assets/css/vendors/feather-icon.css">

    <!-- slick css -->
    <link rel="stylesheet" type="text/css" href="assets/css/vendors/slick/slick.css">
    <link rel="stylesheet" type="text/css" href="assets/css/vendors/slick/slick-theme.css">

    <!-- Iconly css -->
    <link rel="stylesheet" type="text/css" href="assets/css/bulk-style.css">
    <link rel="stylesheet" type="text/css" href="assets/css/vendors/animate.css">

    <!-- Template css -->
    <link id="color-link" rel="stylesheet" type="text/css" href="assets/css/style.css">

    <!-- 自己的css -->
    <link rel="stylesheet" href="assets/css/styleGuide.css">
    <style>
        .tra_list>a {
            color: #bfb9fc;
        }
    </style>
</head>

<body>
    <!-- Header Start -->
    <header class="pb-md-4 pb-0">
        <div class="top-nav top-header sticky-header">
            <div class="container-fluid-lg">
                <div class="row">
                    <div class="col-12">
                        <div class="navbar-top">
                            <button class="navbar-toggler d-xl-none d-inline navbar-menu-button" type="button"
                                data-bs-toggle="offcanvas" data-bs-target="#primaryMenu">
                                <span class="navbar-toggler-icon">
                                    <i class="fa-solid fa-bars"></i>
                                </span>
                            </button>
                            <a href="index.html" class="web-logo nav-logo">
                                <img src="assets/images/logo/1.png" class="img-fluid blur-up lazyload" alt="">
                            </a>
                            <div class="rightside-box">
                                <ul class="right-side-menu">
                                    <li class="right-side">

                                    </li>
                                    <!-- 小鈴鐺 -->
                                    <li class="right-side">
                                        <a href="#" class="delivery-login-box">
                                            <div class="delivery-icon">
                                                <i class="fas fa-bell fa-2x fas-icon"></i>
                                            </div>
                                        </a>
                                    </li>
                                    <!-- 購物車 -->
                                    <li class="right-side">
                                        <div class="onhover-dropdown header-badge">
                                            <button type="button" class="btn p-0 position-relative header-wishlist">
                                                <i data-feather="shopping-cart"></i>
                                                <span class="position-absolute top-0 start-100 translate-middle badge">2
                                                    <span class="visually-hidden">unread messages</span>
                                                </span>
                                            </button>

                                            <div class="onhover-div">
                                                <ul class="cart-list">
                                                    <li class="product-box-contain">
                                                        <div class="drop-cart">
                                                            <a href="product-left-thumbnail.html" class="drop-image">
                                                                <img src="assets/images/vegetable/product/1.png"
                                                                    class="blur-up lazyload" alt="">
                                                            </a>

                                                            <div class="drop-contain">
                                                                <a href="product-left-thumbnail.html">
                                                                    <h5>Fantasy Crunchy Choco Chip Cookies</h5>
                                                                </a>
                                                                <h6><span>1 x</span> $80.58</h6>
                                                                <button class="close-button close_button">
                                                                    <i class="fa-solid fa-xmark"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </li>

                                                    <li class="product-box-contain">
                                                        <div class="drop-cart">
                                                            <a href="product-left-thumbnail.html" class="drop-image">
                                                                <img src="assets/images/vegetable/product/2.png"
                                                                    class="blur-up lazyload" alt="">
                                                            </a>

                                                            <div class="drop-contain">
                                                                <a href="product-left-thumbnail.html">
                                                                    <h5>Peanut Butter Bite Premium Butter Cookies 600 g
                                                                    </h5>
                                                                </a>
                                                                <h6><span>1 x</span> $25.68</h6>
                                                                <button class="close-button close_button">
                                                                    <i class="fa-solid fa-xmark"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </li>
                                                </ul>

                                                <div class="price-box">
                                                    <h5>Total :</h5>
                                                    <h4 class="theme-color fw-bold">$106.58</h4>
                                                </div>

                                                <div class="button-group">
                                                    <a href="cart.html" class="btn btn-sm cart-button">View Cart</a>
                                                    <a href="checkout.html" class="btn btn-sm cart-button theme-bg-color
                                                    text-white">Checkout</a>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <!-- 聊天室 -->
                                    <li class="right-side">
                                        <a href="#" class="btn p-0 position-relative header-wishlist">
                                            <i class="fab fa-rocketchat fas-icon"></i>
                                        </a>
                                    </li>
                                    <!-- 個人中心 -->
                                    <li class="right-side onhover-dropdown">
                                        <div class="delivery-login-box">
                                            <div class="delivery-icon">
                                                <i data-feather="user"></i>
                                            </div>
                                            <div class="delivery-detail">
                                                <h6>Hello,</h6>
                                                <h5>My Account</h5>
                                            </div>
                                        </div>

                                        <div class="onhover-div onhover-div-login">
                                            <ul class="user-box-name">
                                                <li class="product-box-contain">
                                                    <i></i>
                                                    <a href="login.html" id="logout">登出</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container-fluid-lg">
            <div class="row">
                <div class="col-12">
                    <div class="header-nav">
                        <div class="header-nav-middle">
                            <div class="main-nav navbar navbar-expand-xl navbar-light navbar-sticky">
                                <div class="offcanvas offcanvas-collapse order-xl-2" id="primaryMenu">
                                    <div class="offcanvas-body">
                                        <ul class="navbar-nav">
                                            <li class="nav-item dropdown trip">
                                                <a class="nav-link dropdown-toggle" href="javascript:void(0)"
                                                    data-bs-toggle="dropdown">出遊</a>
                                                <ul class="dropdown-menu">
                                                    <li>
                                                        <a class="dropdown-item" href="#">舉辦活動</a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="#">參加活動</a>
                                                    </li>
                                                </ul>
                                            </li>

                                            <li class="nav-item dropdown">
                                                <a class="nav-link" href="#">團購</a>
                                            </li>

                                            <li class="nav-item dropdown">
                                                <a class="nav-link" href="#">商城</a>
                                            </li>

                                            <li class="nav-item dropdown">
                                                <a class="nav-link" href="#">交流天地</a>
                                            </li>

                                            <li class="nav-item">
                                                <a class="nav-link" href="/template/front-end/about.html">關於我們</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container  align-items-center mt-4 member-infor">
        <div class="row">
            <div class="col member_infor h5">
                <a href="update_imfor.html">個人資訊</a>
            </div>
            <div class="col pet_infor h5">
                <a href="pet.html">毛孩資訊</a>
            </div>

            <div class="col act_list h5">
                <a href="trip.html">活動清單</a>
            </div>
            <div class="col tra_list h5">
                <a href="collect.html">追蹤清單</a>
            </div>
            <div class="col order_list h5">
                <a href="myOrder.html">訂單</a>
            </div>

        </div>
    </div>
    <hr>

    <!-- start collect -->
    <div class="container">
        <div class="row mx-auto mt-5  justify-content-center">
            <div class="col-md-8">
                <div class="btn-group mb-3" role="group">
                    <button type="button" class="btn btn-warning rounded-pill filter-btn"
                        data-filter="activity">活動</button>
                    <button type="button" class="btn btn-warning rounded-pill filter-btn"
                        data-filter="product">商品</button>
                </div>
            </div>
        </div>
        <div class="row mt-3 justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <ul class="list-group" id="item-list">
                            <li
                                class="list-group-item d-flex justify-content-between align-items-center font-weight-bold">
                                <!-- <div class="w-25">類型</div> -->
                                <div class="w-50">名稱</div>
                                <div id="date-and-price" class="w-50">日期</div>
                            </li>
                            <li id="item-list-2">
                                <!-- 項目將在JavaScript中動態生成 -->
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-8">
                <div class="d-flex justify-content-center" id="pagination"></div>
            </div>
        </div>
    </div>
    <!-- end collect -->

    <!-- Footer Section Start -->
    <footer class="section-t-space">
        <div class="container-fluid-lg">
            <div class="main-footer section-b-space section-t-space">
                <div class="row g-md-4 g-3">
                    <div class="col-xl-4 col-lg-3 col-sm-6">
                        <div class="footer-title">
                            <h4>聯絡我們</h4>
                        </div>

                        <div class="footer-contact">
                            <ul class="address">
                                <li>
                                    <i data-feather="home"></i>
                                    <a
                                        href="https://www.google.com/maps/place/TibaMe+%E5%85%A8%E6%96%B9%E4%BD%8D%E6%95%B8%E4%BD%8D%E8%A1%8C%E9%8A%B7%E5%AF%A6%E6%88%B0%E9%A4%8A%E6%88%90%E7%8F%AD(%E5%8F%B0%E5%8C%97)/@25.0521328,121.540678,17z/data=!3m2!4b1!5s0x3442abddfc0bc85f:0x547998e4a2421286!4m6!3m5!1s0x346823c18fcb9855:0x784fb0d91b7fc01f!8m2!3d25.052128!4d121.5432529!16s%2Fg%2F11b_0002l9?authuser=0&entry=ttu">104台北市中山區南京東路三段219號5樓</a>
                                </li>
                                <li>
                                    <i data-feather="mail"></i>
                                    <a href="javascript:void(0)">support@gmail.com</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="col-xl-4 col-lg-3 col-sm-6">
                        <div class="footer-logo">
                            <div class="theme-logo">
                                <a href="index.html">
                                    <img src="assets/images/logo/2.png" class="blur-up lazyload" alt="">
                                </a>
                            </div>

                            <div class="footer-logo-contain">
                                <p>
                                    我們為毛孩與主人設計了一個揪團出遊及團購毛孩用品的交流平台，來吸引主人帶著毛小孩彼此見面交流，促進毛小孩社會化之餘，來創造話題並帶動寵物市場之商機。
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-4 col-lg-3 col-md-4 col-sm-6">
                        <div class="footer-title">
                            <h4>免責聲明</h4>
                        </div>

                        <div class="footer-contain">
                            <ul>
                                <li>
                                    <a href="shop-left-sidebar.html" class="text-content">Vegetables & Fruit</a>
                                </li>
                                <li>
                                    <a href="shop-left-sidebar.html" class="text-content">Beverages</a>
                                </li>
                                <li>
                                    <a href="shop-left-sidebar.html" class="text-content">Meats & Seafood</a>
                                </li>
                                <li>
                                    <a href="shop-left-sidebar.html" class="text-content">Frozen Foods</a>
                                </li>
                                <li>
                                    <a href="shop-left-sidebar.html" class="text-content">Biscuits & Snacks</a>
                                </li>
                                <li>
                                    <a href="shop-left-sidebar.html" class="text-content">Grocery & Staples</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </footer>
    <!-- Footer Section End -->
    <!-- latest jquery-->
    <script src="assets/js/jquery-3.6.0.min.js"></script>

    <!-- jquery ui-->
    <script src="assets/js/jquery-ui.min.js"></script>

    <!-- Bootstrap js-->
    <script src="assets/js/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="assets/js/bootstrap/bootstrap-notify.min.js"></script>
    <script src="assets/js/bootstrap/popper.min.js"></script>

    <!-- feather icon js-->
    <script src="assets/js/feather/feather.min.js"></script>
    <script src="assets/js/feather/feather-icon.js"></script>

    <!-- Lazyload Js -->
    <script src="assets/js/lazysizes.min.js"></script>

    <!-- Slick js-->
    <script src="assets/js/slick/slick.js"></script>
    <script src="assets/js/slick/slick-animation.min.js"></script>
    <script src="assets/js/slick/custom_slick.js"></script>

    <!-- Auto Height Js -->
    <script src="assets/js/auto-height.js"></script>

    <!-- Timer Js -->
    <!-- <script src="assets/js/timer1.js"></script> -->

    <!-- Fly Cart Js -->
    <script src="assets/js/fly-cart.js"></script>

    <!-- Quantity js -->
    <script src="assets/js/quantity-2.js"></script>

    <!-- WOW js -->
    <script src="assets/js/wow.min.js"></script>
    <script src="assets/js/custom-wow.js"></script>

    <!-- script js -->
    <script src="assets/js/script.js"></script>

    <script>
        // 在DOM加載完成後執行
        document.addEventListener("DOMContentLoaded", function () {
            var items = [];

            const username = sessionStorage.getItem("username");
            const uid = sessionStorage.getItem("uid");
            $("h5").text(username);
            const fetchActivity = fetch('tracetrip', {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    uid: uid
                }),
            })
                .then(response => response.json());

            // 商品
            const fetchProduct = fetch('findmyproduct', {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    uid: uid
                }),
            })
                .then(response => response.json());

            Promise.all([fetchActivity, fetchProduct])
                .then(([activityData, productData]) => {
                    items = []; // 清空 items

                    items = items.concat(Array.isArray(activityData.activity) ? activityData.activity : []);
                    addActivityItemToList(items); // 使用轉換後的數組
                    items.forEach(function (item) {
                        item.t1 = "activity";
                    });

                    items = items.concat(Array.isArray(productData.product) ? productData.product : []);
                    addProductItemToList(items); // 使用轉換後的數組
                    items.forEach(function (item) {
                        item.p1 = "product";
                    });
                })
                .catch(error => {
                    console.error('發生錯誤：', error);
                });


            var filterBtns = document.querySelectorAll(".filter-btn");
            var itemList = document.getElementById("item-list-2");
            const date_and_price = $("div#date-and-price");

            function switchFilter(filter) {
                // 清空項目列表
                while (itemList.firstChild) {
                    itemList.innerHTML = "";
                }

                // 根據篩選條件添加相應的項目
                if (filter === "activity") {
                    // 添加活動項目
                    addActivityItemsByFilter("activity");
                } else if (filter === "product") {
                    // 添加商品項目
                    addProductItemsByFilter("product");
                }
            }

            // 監聽過濾按鈕的點擊事件
            filterBtns.forEach(function (btn) {
                btn.addEventListener("click", function () {
                    var filter = btn.dataset.filter;
                    console.log(filter);
                    switchFilter(filter);
                });
            });

            // 新增項目到列表中
            function addActivityItemToList(item) {
                // console.log(item.tactName);

                date_and_price.text("日期");

                var itemElement = document.createElement("li");
                itemElement.classList.add("list-group-item");

                var itemContent = document.createElement("div");
                itemContent.classList.add("d-flex", "align-items-center", "justify-content-between");

                var itemDate = document.createElement("span");
                const time = timeFormat(item.tactTime);
                if (time === 'NaN-NaN-NaN') {
                    return
                }
                itemDate.textContent = time;

                var itemName = document.createElement("span");
                itemName.textContent = item.tactName;

                var itemActions = document.createElement("span");
                itemActions.innerHTML = `
                    <a href="#" class="btn btn-sm btn-info me-2" data-action="view" data-item="${item.tactName}" data-id="${item.tactId}" data-type="${item.t1}">查看</a>
                    <button class="btn btn-sm btn-danger rounded-pill" data-action="delete" data-item="${item.tactName}" data-id="${item.tactId}" data-type="${item.t1}">刪除</button>
                `;

                itemContent.appendChild(itemName);
                itemContent.appendChild(itemDate);

                itemElement.appendChild(itemContent);
                itemContent.appendChild(itemActions);

                itemList.appendChild(itemElement);
            }

            function addProductItemToList(item) {
                // console.log(item.pprice);

                date_and_price.text("價格");

                var itemElement = document.createElement("li");
                itemElement.classList.add("list-group-item");

                var itemContent = document.createElement("div");
                itemContent.classList.add("d-flex", "align-items-center", "justify-content-between");

                var itemDate = document.createElement("span");
                itemDate.textContent = item.pprice;

                var itemName = document.createElement("span");
                itemName.textContent = item.pname;

                var itemActions = document.createElement("span");
                itemActions.innerHTML = `
                    <a href="#" class="btn btn-sm btn-info me-2" data-action="view" data-item="${item.pname}" data-id="${item.pId}" data-type="${item.p1}">查看</a>
                    <button class="btn btn-sm btn-danger rounded-pill" data-action="delete" data-item="${item.pname}" data-id="${item.pId}" data-type="${item.p1}">刪除</button>
                `;

                itemContent.appendChild(itemName);
                itemContent.appendChild(itemDate);

                itemElement.appendChild(itemContent);
                itemContent.appendChild(itemActions);

                itemList.appendChild(itemElement);
            }

            // 根據篩選條件添加項目
            function addActivityItemsByFilter(filter) {
                var filteredItems = items.filter(function (item) {
                    // 檢查 items 物件是否有 t1 這個 key
                    if (item.t1 === "activity") {
                        return true;
                    }
                    return false;
                });

                // 清空項目列表
                itemList.innerHTML = "";

                // 添加活動項目
                filteredItems.forEach(function (item) {
                    // console.log(item);
                    addActivityItemToList(item);
                });
            }

            // 根據篩選條件添加項目
            function addProductItemsByFilter(filter) {
                var filteredItems = items.filter(function (item) {
                    // 檢查 items 物件是否有 p1 這個 key
                    if (item.t1 !== "activity" && item.p1 === "product") {
                        return true;
                    }
                    return false;
                });

                // 清空項目列表
                itemList.innerHTML = "";

                // 添加商品項目
                filteredItems.forEach(function (item) {
                    // console.log(item);
                    addProductItemToList(item);
                });
            }

            // 預設顯示所有項目
            switchFilter("activity");

            // 監聽項目操作的點擊事件
            itemList.addEventListener("click", function (event) {
                var target = event.target;
                var action = target.dataset.action;
                var item = target.dataset.item;
                var pid = target.dataset.id;
                console.log(pid);
                var type = target.dataset.type;
                // console.log(type);
                if (action === "view") {
                    // 查看活動頁面
                    console.log("查看活動：" + item);

                    if (type === "activity") {
                        console.log("查看活動：" + item);

                        redirectToJoinPage(pid);
                        // 根據活動 ID 執行跳轉操作
                        // if (pid) {
                        //     // 假設您的活動頁面 URL 是 activity.html，這裡以 pid 為參數
                        //     const activityUrl = `activity.html?id=${pid}`;
                        //     location.href = activityUrl;
                        // }
                    } else if (type === "product") {
                        console.log("查看商品：" + item);
                        // 使用 fetch 向後端傳送商品的 p_id 以獲取商品詳細資料
                        fetch(`shop/productDetail?p_id=${pid}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                            .then(response => response.json())
                            .then(data => {
                                console.log("商品詳細資料:", data.viewProductDetail);
                                // 重新導向到 product-4-image.html 頁面，並將 p_id 作為查詢參數傳遞
                                location.href = `product-4-image.html?p_id=${pid}`;
                            })

                            .catch(error => {
                                // 錯誤處理
                                console.error("請求錯誤:", error);
                            });
                        // 根據商品 ID 執行跳轉操作
                        // if (pid) {
                        //     // 假設您的商品頁面 URL 是 product.html，這裡以 pid 為參數
                        //     const productUrl = `product.html?id=${pid}`;
                        //     location.href = productUrl;


                        // }
                    }

                } else if (action === "delete") {
                    // 刪除項目
                    console.log("刪除項目：" + item);
                    const npid = parseInt(pid);
                    console.log(npid);
                    console.log(type);
                    if (type === 'product') {
                        fetch('deletemyproductlike?pid=' + npid, {
                            method: "POST",
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                uid: uid,
                                pid: npid
                            })
                        })
                            .then(responce => responce.json())
                            .then(data => {
                                if (data.success === 1) {
                                    alert("移除成功");
                                    target.closest(".list-group-item").remove();
                                }
                            })
                    } else if (type === 'activity') {
                        fetch('deletemytrip?pid=' + npid, {
                            method: "POST",
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                uid: uid,
                                pid: npid
                            })
                        })
                            .then(responce => responce.json())
                            .then(data => {
                                if (data.success === 1) {
                                    alert("移除成功");
                                    target.closest(".list-group-item").remove();
                                    location.reload();
                                }
                            })
                    }
                }
            });

            $("a#logout").on("click", function (e) {
                e.preventDefault();
                fetch("logout", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    }
                })
                    .then(responce => responce.json())
                    .then(data => {
                        if (data.logoutsuccess === 1) {

                            alert("登出成功");
                            sessionStorage.clear();
                            location.href = "login.html";
                        }

                    })
            })
        });
        function timeFormat(timeString) {
            // 使用Date物件解析日期時間字串
            const date = new Date(timeString);

            // 取得日期部分
            const year = date.getFullYear();
            const month = date.getMonth() + 1; // 注意月份是從0開始的，所以要加1
            const day = date.getDate();

            // 以所需格式組合日期
            const formattedDate = `${year}-${month < 10 ? '0' + month : month}-${day < 10 ? '0' + day : day}`;

            // 回傳格式化後的日期
            return formattedDate;
        }

        function redirectToJoinPage(t_act_id) {
            sessionStorage.setItem('t_act_id', t_act_id);
            const joinPageUrl = `join-events.html?t_act_id=${t_act_id}`;
            window.open(joinPageUrl, '_blank');
        }
    </script>



</body>

</html>